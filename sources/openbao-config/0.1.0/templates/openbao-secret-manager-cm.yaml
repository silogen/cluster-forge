apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-secret-manager-scripts
  namespace: cf-openbao
data:
  manage-secrets.sh: |
    #!/bin/bash
    set -e
    
    # Validate environment
    if [ -z "$BAO_TOKEN" ]; then
      echo "ERROR: BAO_TOKEN not set"
      exit 1
    fi
    
    echo "Managing OpenBao secrets from /tmp/secrets/secrets.env..."
    
    created=0
    skipped=0
    
    while IFS='|' read -r path type value bytes; do
      [[ "$path" =~ ^#.*$ ]] || [[ -z "$path" ]] && continue
      
      if bao kv get "$path" > /dev/null 2>&1; then
        echo "SKIP: $path (already exists)"
        skipped=$((skipped + 1))
      else
        echo "CREATE: $path ($type)"
        
        if [ "$type" = "static" ]; then
          final_value=$(echo "$value" | envsubst)
          bao kv put "$path" value="$final_value" || { echo "ERROR: Failed to create $path"; exit 1; }
        elif [ "$type" = "random" ]; then
          random_value=$(bao write -field=random_bytes sys/tools/random bytes="$bytes" format=hex) || { echo "ERROR: Failed to generate random for $path"; exit 1; }
          bao kv put "$path" value="$random_value" || { echo "ERROR: Failed to store $path"; exit 1; }
        else
          echo "ERROR: Unknown secret type: $type"
          exit 1
        fi
        
        created=$((created + 1))
      fi
    done < /tmp/secrets/secrets.env
    
    echo "DONE: Created $created, Skipped $skipped"
    
    # Special case: cluster-auth-openbao-token uses actual BAO_TOKEN (for init job only)
    if [ "$INIT_MODE" = "true" ]; then
      echo "CREATE: secrets/cluster-auth-openbao-token (special - init mode)"
      bao kv put secrets/cluster-auth-openbao-token value="${BAO_TOKEN}" || { echo "ERROR: Failed to create cluster-auth-openbao-token"; exit 1; }
      echo "Initial secret generation completed"
    fi