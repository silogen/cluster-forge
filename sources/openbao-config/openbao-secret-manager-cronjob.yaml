apiVersion: batch/v1
kind: CronJob
metadata:
  name: openbao-secret-manager
  namespace: cf-openbao
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  concurrencyPolicy: Forbid  # Don't run multiple jobs concurrently
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 300  # 5 minute timeout
      backoffLimit: 1  # Only retry once on failure
      template:
        spec:
          serviceAccountName: openbao-secret-manager-sa
          restartPolicy: Never
          containers:
          - name: secret-manager
            image: ghcr.io/silogen/cluster-tool:latest
            command: ["/bin/bash", "-c"]
            args:
              - |
                echo "OpenBao Secret Manager CronJob starting..."
                
                # Set OpenBao address
                export BAO_ADDR=http://openbao-internal:8200
                
                # Get OpenBao token from Kubernetes secret
                export BAO_TOKEN=$(kubectl get secret openbao-keys -n cf-openbao -o jsonpath='{.data.root_token}' | base64 -d)
                if [ -z "$BAO_TOKEN" ]; then
                  echo "ERROR: Failed to retrieve OpenBao root token"
                  exit 1
                fi
                
                # Set domain from template (will be replaced during deployment)
                export DOMAIN="{{ .Values.domain }}"
                
                echo "BAO_ADDR: $BAO_ADDR"
                echo "DOMAIN: $DOMAIN"
                echo "Running secret management script..."
                
                # Run the secret management script
                /tmp/scripts/manage-secrets.sh
            env:
            - name: BAO_ADDR
              value: http://openbao-internal:8200
            resources:
              requests:
                memory: "64Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
            volumeMounts:
            - name: scripts
              mountPath: /tmp/scripts
            - name: secrets-config
              mountPath: /tmp/secrets
          volumes:
          - name: scripts
            configMap:
              name: openbao-secret-manager-scripts
              defaultMode: 0755
          - name: secrets-config
            configMap:
              name: openbao-secrets-config