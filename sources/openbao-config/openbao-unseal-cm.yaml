apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-unseal-scripts
  namespace: cf-openbao
data:
  unseal-openbao.sh: |
    #!/bin/bash
    
    set -e
    if [ -z "$UNSEAL_KEY" ]; then
      echo "ERROR: UNSEAL_KEY is not set"
      exit 1
    fi
    
    kubectl get pods -l app.kubernetes.io/name=openbao -n cf-openbao -o json | \
      jq -r '.items[] | select(.status.phase=="Running") | select(.status.conditions[] | select(.type=="Ready" and .status=="False")) | .metadata.name' | \
      while read POD; do
        echo "Unsealing $POD..."
        kubectl exec -n cf-openbao $POD -- bao operator unseal "$UNSEAL_KEY"
      done
