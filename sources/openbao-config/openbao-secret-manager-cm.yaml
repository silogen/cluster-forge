apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-secret-manager-scripts
  namespace: cf-openbao
data:
  manage-secrets.sh: |
    #!/bin/bash
    set -e
    
    echo "Starting OpenBao secret management..."
    echo "Reading secret definitions from /tmp/secrets/secrets.env"
    
    # Ensure we have required environment variables
    if [ -z "$BAO_TOKEN" ]; then
      echo "ERROR: BAO_TOKEN environment variable is not set"
      exit 1
    fi
    
    if [ -z "$BAO_ADDR" ]; then
      export BAO_ADDR="http://openbao-internal:8200"
      echo "INFO: Using default BAO_ADDR: $BAO_ADDR"
    fi
    
    # Initialize counters
    processed=0
    created=0
    skipped=0
    errors=0
    
    echo "Processing secret definitions..."
    
    # Read secrets from config file
    while IFS='|' read -r path type value bytes; do
      # Skip comments and empty lines
      if [[ "$path" =~ ^#.*$ ]] || [[ -z "$path" ]]; then
        continue
      fi
      
      processed=$((processed + 1))
      echo "Processing secret: $path (type: $type)"
      
      # Check if secret already exists
      if bao kv get "$path" > /dev/null 2>&1; then
        echo "  → Secret $path already exists, skipping..."
        skipped=$((skipped + 1))
        continue
      fi
      
      echo "  → Creating secret $path..."
      
      # Create secret based on type
      if [ "$type" = "static" ]; then
        # Replace template variables (like {{ .Values.domain }})
        final_value=$(echo "$value" | envsubst)
        if bao kv put "$path" value="$final_value" > /dev/null 2>&1; then
          echo "  ✓ Secret $path created with static value"
          created=$((created + 1))
        else
          echo "  ✗ Failed to create secret $path"
          errors=$((errors + 1))
        fi
      elif [ "$type" = "random" ]; then
        if [ -z "$bytes" ] || [ "$bytes" = "0" ]; then
          echo "  ✗ Error: random type requires bytes > 0"
          errors=$((errors + 1))
          continue
        fi
        
        random_value=$(bao write -field=random_bytes sys/tools/random bytes="$bytes" format=hex 2>/dev/null)
        if [ $? -eq 0 ] && [ -n "$random_value" ]; then
          if bao kv put "$path" value="$random_value" > /dev/null 2>&1; then
            echo "  ✓ Secret $path created with random value ($bytes bytes)"
            created=$((created + 1))
          else
            echo "  ✗ Failed to store secret $path"
            errors=$((errors + 1))
          fi
        else
          echo "  ✗ Failed to generate random value for $path"
          errors=$((errors + 1))
        fi
      else
        echo "  ✗ Unknown secret type: $type"
        errors=$((errors + 1))
        continue
      fi
      
    done < /tmp/secrets/secrets.env
    
    # Print summary
    echo ""
    echo "=== Secret Management Summary ==="
    echo "Processed: $processed secrets"
    echo "Created:   $created secrets"
    echo "Skipped:   $skipped secrets (already exist)"
    echo "Errors:    $errors secrets"
    echo ""
    
    if [ $errors -gt 0 ]; then
      echo "WARNING: $errors secrets had errors during processing"
      exit 1
    else
      echo "✓ Secret management completed successfully"
      exit 0
    fi