# Copyright Â© Advanced Micro Devices, Inc., or its affiliates.
#
# SPDX-License-Identifier: MIT

---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ include "aiwb.fullname" . }}-cnpg
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "aiwb.labels" . | nindent 4 }}
spec:
  affinity:
    enablePodAntiAffinity: true
    topologyKey: topology.kubernetes.io/zone
  bootstrap:
    initdb:
      database: {{ .Values.postgresql.database }}
      owner: {{ .Values.postgresql.username | quote }}
      postInitSQL:
        - GRANT CREATE ON SCHEMA public TO "{{ .Values.postgresql.username }}"
      secret:
        name: {{ .Values.postgresql.userSecretName }}
  imageName: {{ .Values.postgresql.image }}
  instances: {{ .Values.postgresql.instances }}
  nodeMaintenanceWindow:
    inProgress: false
    reusePVC: true
  postgresql:
    parameters:
      auto_explain.log_min_duration: "10s"
      pg_stat_statements.max: "10000"
      pg_stat_statements.track: "all"
      shared_buffers: {{ .Values.postgresql.sharedBuffers | quote }}
      wal_compression: "pglz"
    pg_hba:
      # Allow connections from pods in the cluster
      - host all all 10.244.0.0/16 md5
  primaryUpdateStrategy: unsupervised
  resources:
    {{- toYaml .Values.postgresql.resources | nindent 4 }}
  startDelay: 300
  stopDelay: 300
  storage:
    {{- toYaml .Values.postgresql.storage | nindent 4 }}
  superuserSecret:
    name: {{ .Values.postgresql.superuserSecretName }}
  walStorage:
    {{- toYaml .Values.postgresql.walStorage | nindent 4 }}
