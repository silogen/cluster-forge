# Copyright Â© Advanced Micro Devices, Inc., or its affiliates.
#
# SPDX-License-Identifier: MIT

# =============================================================================
# Core secrets (always required)
# =============================================================================
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.minio.credentialsSecretName }}
  namespace: {{ .Release.Namespace }}
  annotations:
    helm.sh/hook: pre-install
spec:
  data:
    - remoteRef:
        key: minio-api-access-key
        property: value
      secretKey: {{ .Values.minio.accessKeyKey }}
    - remoteRef:
        key: minio-api-secret-key
        property: value
      secretKey: {{ .Values.minio.secretKeyKey }}
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-secret-store
  target:
    name: {{ .Values.minio.credentialsSecretName }}
    template:
      type: Opaque
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.keycloak.secretName }}
  namespace: {{ .Release.Namespace }}
  annotations:
    helm.sh/hook: pre-install
spec:
  data:
    - remoteRef:
        key: aiwb-ui-keycloak-secret
        property: value
      secretKey: value
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-secret-store
  target:
    name: {{ .Values.keycloak.secretName }}
    template:
      type: Opaque
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.clusterAuth.secretName }}
  namespace: {{ .Release.Namespace }}
  annotations:
    helm.sh/hook: pre-install
spec:
  data:
    - remoteRef:
        key: aiwb-cluster-auth-admin-token
        property: value
      secretKey: value
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-secret-store
  target:
    name: {{ .Values.clusterAuth.secretName }}
    template:
      type: Opaque
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.database.secretName }}
  namespace: {{ .Release.Namespace }}
  annotations:
    helm.sh/hook: pre-install
spec:
  data:
    - remoteRef:
        key: aiwb-cnpg-user-username
        property: value
      secretKey: username
    - remoteRef:
        key: aiwb-cnpg-user-password
        property: value
      secretKey: password
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-secret-store
  target:
    name: {{ include "aiwb.fullname" . }}-cnpg-user
    template:
      type: Opaque
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "aiwb.fullname" . }}-cnpg-superuser
  namespace: {{ .Release.Namespace }}
  annotations:
    helm.sh/hook: pre-install
spec:
  data:
    - remoteRef:
        key: aiwb-cnpg-superuser-username
        property: value
      secretKey: username
    - remoteRef:
        key: aiwb-cnpg-superuser-password
        property: value
      secretKey: password
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-secret-store
  target:
    name: {{ include "aiwb.fullname" . }}-cnpg-superuser
    template:
      type: Opaque
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.frontend.nextAuthSecretName }}
  namespace: {{ .Release.Namespace }}
  annotations:
    helm.sh/hook: pre-install
spec:
  data:
    - remoteRef:
        key: aiwb-ui-auth-nextauth-secret
        property: value
      secretKey: NEXTAUTH_SECRET
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-secret-store
  target:
    name: {{ .Values.frontend.nextAuthSecretName }}
    template:
      type: Opaque

# =============================================================================
# Standalone mode secrets (only when not integrated with AIRM)
# =============================================================================
{{- if .Values.standAloneMode }}
---
# MinIO credentials for the workbench namespace
# This allows workloads in the workbench namespace to access MinIO
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.minio.credentialsSecretName }}
  namespace: {{ .Values.defaultNamespace | default "workbench" }}
  annotations:
    helm.sh/hook: post-install
spec:
  data:
    - remoteRef:
        key: minio-api-access-key
        property: value
      secretKey: {{ .Values.minio.accessKeyKey }}
    - remoteRef:
        key: minio-api-secret-key
        property: value
      secretKey: {{ .Values.minio.secretKeyKey }}
  secretStoreRef:
    kind: ClusterSecretStore
    name: openbao-secret-store
  target:
    name: {{ .Values.minio.credentialsSecretName }}
    template:
      type: Opaque
{{- end }}
