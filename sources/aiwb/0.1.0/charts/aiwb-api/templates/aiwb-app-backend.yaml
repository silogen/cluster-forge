# Copyright Â© Advanced Micro Devices, Inc., or its affiliates.
#
# SPDX-License-Identifier: MIT

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: "{{ .Release.Name }}-api"
  name: "{{ .Release.Name }}-api"
  namespace: "{{ .Release.Namespace }}"
spec:
  ports:
    - name: web
      port: {{ .Values.aiwb.backend.servicePort }}
      targetPort: 8002
    - name: metrics
      port: {{ .Values.aiwb.backend.servicePortMetrics }}
      targetPort: 9009
  selector:
    app: "{{ .Release.Name }}-api"
  type: ClusterIP
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "{{ .Release.Name }}-api"
  namespace: "{{ .Release.Namespace }}"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "{{ .Release.Name }}-api"
rules:
# AIMService CRD access
- apiGroups: ["aim.amd.com"]
  resources: ["aimservices"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Kubernetes Secret access (on-demand reads, no database persistence)
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Namespace discovery (for combined mode)
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "watch"]

# ConfigMap access (for GPU metrics configuration)
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]

# Pod and Service access (for workload monitoring)
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch"]

# PersistentVolumeClaim access (for workload storage)
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "watch"]

# HTTPRoute access (for Gateway API)
- apiGroups: ["gateway.networking.k8s.io"]
  resources: ["httproutes"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Helm Release access
- apiGroups: ["helm.toolkit.fluxcd.io"]
  resources: ["helmreleases"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "{{ .Release.Name }}-api"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "{{ .Release.Name }}-api"
subjects:
- kind: ServiceAccount
  name: "{{ .Release.Name }}-api"
  namespace: "{{ .Release.Namespace }}"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ .Release.Name }}-api"
  namespace: "{{ .Release.Namespace }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "{{ .Release.Name }}-api"
  template:
    metadata:
      labels:
        app: "{{ .Release.Name }}-api"
    spec:
      serviceAccountName: "{{ .Release.Name }}-api"
      containers:
        - env:
            # Database configuration
            - name: DATABASE_HOST
              value: "{{ .Release.Name }}-cnpg-rw.{{ .Release.Namespace }}.svc.cluster.local"
            - name: DATABASE_PORT
              value: "{{ .Values.aiwb.backend.env.dbPort }}"
            - name: DATABASE_NAME
              value: "aiwb"
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: "{{ .Release.Name }}-cnpg-user"
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: "{{ .Release.Name }}-cnpg-user"

            # Keycloak/OIDC configuration
            - name: KEYCLOAK_URL
              value: {{ template "aiwb-api.keycloakPublicUrl" . }}
            - name: KEYCLOAK_REALM
              value: "{{ .Values.aiwb.keycloak.realm }}"
            - name: KEYCLOAK_CLIENT_ID
              value: "{{ .Values.aiwb.keycloak.clientId }}"
            - name: KEYCLOAK_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  key: client-secret
                  name: "{{ .Release.Name }}-keycloak-client"

            # MinIO configuration
            - name: MINIO_URL
              value: "{{ .Values.aiwb.backend.env.minioUrl }}"
            - name: MINIO_BUCKET
              value: "{{ .Values.aiwb.backend.env.minioBucket }}"
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: minio-access-key
                  name: "{{ .Release.Name }}-api-minio-credentials"
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: minio-secret-key
                  name: "{{ .Release.Name }}-api-minio-credentials"
            - name: MINIO_MAX_ATTEMPTS
              value: "{{ .Values.aiwb.minio.maxAttempts }}"
            - name: MINIO_MIN_WAIT
              value: "{{ .Values.aiwb.minio.minWait }}"
            - name: MINIO_MAX_WAIT
              value: "{{ .Values.aiwb.minio.maxWait }}"

            # ClusterAuth configuration
            - name: CLUSTER_AUTH_URL
              value: "{{ .Values.aiwb.clusterAuth.url }}"
            - name: CLUSTER_AUTH_ADMIN_TOKEN
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cluster-auth-admin"
                  key: admin-token
                  optional: true

            # AIWB Application Configuration
            - name: AIWB_DEPLOYMENT_MODE
              value: "{{ .Values.aiwb.config.deploymentMode }}"
            - name: AIWB_DEFAULT_NAMESPACE
              value: "{{ .Values.aiwb.config.defaultNamespace }}"
            - name: AIWB_NAMESPACE_LABEL
              value: "{{ .Values.aiwb.config.namespaceLabelSelector }}"

            # Kubernetes configuration
            - name: USE_LOCAL_KUBE_CONTEXT
              value: "false"

            # Polling Intervals
            - name: WORKLOAD_POLLING_INTERVAL_SECONDS
              value: "{{ .Values.aiwb.polling.workloadInterval }}"
            - name: WORKLOAD_PENDING_TIMEOUT_SECONDS
              value: "{{ .Values.aiwb.polling.pendingTimeout }}"

            # Dataset Configuration
            - name: MAX_FILE_SIZE_MB
              value: "{{ .Values.aiwb.datasets.maxFileSizeMB }}"

            # Loki / Logging Configuration
            {{- if .Values.aiwb.loki.enabled }}
            - name: LOKI_URL
              value: "{{ .Values.aiwb.loki.url }}"
            - name: LOKI_TIMEOUT_SECONDS
              value: "{{ .Values.aiwb.loki.timeoutSeconds }}"
            - name: LOKI_DEFAULT_TIME_RANGE_DAYS
              value: "{{ .Values.aiwb.loki.defaultTimeRangeDays }}"
            {{- end }}

            # AIM Configuration
            {{- if .Values.aiwb.aim.enabled }}
            - name: AIM_RUNTIME_CONFIG_NAME
              value: "{{ .Values.aiwb.aim.runtimeConfigName }}"
            - name: AIM_GATEWAY_NAMESPACE
              value: "{{ .Values.kgateway.namespace }}"
            - name: AIM_GATEWAY_NAME
              value: "{{ .Values.kgateway.gatewayName }}"
            - name: CLUSTER_HOST
              value: "{{ .Values.aiwb.appDomain }}"
            {{- end }}

            # Metrics Configuration
            {{- if .Values.aiwb.metrics.enabled }}
            - name: METRICS_CONFIG_MAP_NAMESPACE
              value: "{{ .Values.aiwb.metrics.configMapNamespace }}"
            - name: METRICS_CONFIG_MAP_NAME
              value: "{{ .Values.aiwb.metrics.configMapName }}"
            {{- end }}

            # Prometheus configuration
            - name: PROMETHEUS_URL
              value: "{{ .Values.aiwb.backend.env.prometheusUrl }}"

          image: "{{ .Values.aiwb.backend.image.repository }}:{{ .Values.aiwb.backend.image.tag }}"
          imagePullPolicy: {{ .Values.aiwb.backend.image.pullPolicy }}
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /v1/health
              port: 8002
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          name: aiwb
          ports:
            - containerPort: 8002
            - containerPort: 9009
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /v1/health
              port: 8002
            initialDelaySeconds: 10
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          resources:
            {{- toYaml .Values.aiwb.backend.resources | nindent 12 }}
          securityContext:
            {{- toYaml .Values.aiwb.backend.securityContext | nindent 12 }}
      initContainers:
        - name: wait-for-db
          image: postgres:17-alpine
          command:
            - sh
            - -c
            - |
              until pg_isready -h "{{ .Release.Name }}-cnpg-rw.{{ .Release.Namespace }}.svc.cluster.local" -p 5432 -U postgres; do
                echo "Waiting for database..."
                sleep 2
              done
              echo "Database is ready!"
        - name: init-migration-scripts
          command:
            - sh
            - -c
            - cp /code/migrations/* /mnt/code/migrations/
          image: "{{ .Values.aiwb.backend.image.repository }}:{{ .Values.aiwb.backend.image.tag }}"
          imagePullPolicy: {{ .Values.aiwb.backend.image.pullPolicy }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            - mountPath: /mnt/code/migrations
              name: aiwb-migration-volume
        - name: liquibase-migrate
          command:
            - liquibase
            - --url=jdbc:postgresql://{{ .Release.Name }}-cnpg-rw.{{ .Release.Namespace }}.svc.cluster.local:5432/aiwb
            - --username=$(DATABASE_USER)
            - --password=$(DATABASE_PASSWORD)
            - --logLevel=INFO
            - --changeLogFile=changelog/changelog.xml
            - update
          env:
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: "{{ .Release.Name }}-cnpg-user"
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: "{{ .Release.Name }}-cnpg-user"
          image: "{{ .Values.aiwb.utilities.liquibase.image.repository }}:{{ .Values.aiwb.utilities.liquibase.image.tag }}"
          imagePullPolicy: {{ .Values.aiwb.utilities.liquibase.image.pullPolicy }}
          volumeMounts:
            - mountPath: /liquibase/changelog
              name: aiwb-migration-volume
              readOnly: true
        - name: charts-registration
          image: "{{ .Values.aiwb.backend.image.repository }}:{{ .Values.aiwb.backend.image.tag }}"
          imagePullPolicy: {{ .Values.aiwb.backend.image.pullPolicy }}
          command: ["uv", "run", "-m", "app.charts.registration"]
          env:
            - name: DATABASE_HOST
              value: "{{ .Release.Name }}-cnpg-rw.{{ .Release.Namespace }}.svc.cluster.local"
            - name: DATABASE_PORT
              value: "{{ .Values.aiwb.backend.env.dbPort }}"
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cnpg-user"
                  key: username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cnpg-user"
                  key: password
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
      enableServiceLinks: false
      volumes:
        - emptyDir: {}
          name: aiwb-migration-volume
