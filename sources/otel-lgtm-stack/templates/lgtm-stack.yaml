---
apiVersion: v1
kind: Namespace
metadata:
  labels:
    pod-security.kubernetes.io/enforce: privileged
  name: {{ .Values.namespace }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: tempo-pvc
  namespace: {{ .Values.namespace }}
spec:
  storageClassName: default
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.lgtm.storage.tempo }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: loki-data-pvc
  namespace: {{ .Values.namespace }}
spec:
  storageClassName: default
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.lgtm.storage.loki }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: loki-storage-pvc
  namespace: {{ .Values.namespace }}
spec:
  storageClassName: default
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.lgtm.storage.extra }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
  namespace: {{ .Values.namespace }}
spec:
  storageClassName: default
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.lgtm.storage.grafana }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: p8s-pvc
  namespace: {{ .Values.namespace }}
spec:
  storageClassName: default
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.lgtm.storage.mimir }}
---
# Source: grafana/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana-sidecar
  namespace: {{ .Values.namespace }}
---
# Source: grafana/templates/configmap-dashboard-provider.yaml ######
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
  name: grafana-config-dashboards
  namespace: {{ .Values.namespace }}
data:
  provider.yaml: |-
    apiVersion: 1
    providers:
      - name: 'sidecarProvider'
        orgId: 1
        type: file
        disableDeletion: false
        allowUiUpdates: false
        updateIntervalSeconds: 30
        options:
          foldersFromFilesStructure: true
          path: /tmp/dashboards
---
# Source: grafana/templates/clusterrole.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: grafana-sidecar-clusterrole
rules:
  - apiGroups: [""] # "" indicates the core API group
    resources: ["configmaps", "secrets"]
    verbs: ["get", "watch", "list"]
---
# Source: grafana/templates/clusterrolebinding.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: lgtm-grafana-clusterrolebinding
subjects:
  - kind: ServiceAccount
    name: grafana-sidecar
    namespace: {{ .Values.namespace }}
roleRef:
  kind: ClusterRole
  name: grafana-sidecar-clusterrole
  apiGroup: rbac.authorization.k8s.io
---
# this is intended for demo / testing purposes only, not for production usage
apiVersion: v1
kind: Service
metadata:
  name: lgtm-stack
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: lgtm
  ports:
    - name: grafana
      protocol: TCP
      port: {{ .Values.services.lgtm.grafana }}
      targetPort: {{ .Values.services.lgtm.grafana }}
    - name: otel-grpc
      protocol: TCP
      port: {{ .Values.services.lgtm.otelGrpc }}
      targetPort: {{ .Values.services.lgtm.otelGrpc }}
    - name: otel-http
      protocol: TCP
      port: {{ .Values.services.lgtm.otelHttp }}
      targetPort: {{ .Values.services.lgtm.otelHttp }}
    - name: prometheus
      protocol: TCP
      port: {{ .Values.services.lgtm.prometheus }}
      targetPort: {{ .Values.services.lgtm.prometheus }}
    - name: loki
      protocol: TCP
      port: {{ .Values.services.lgtm.loki }}
      targetPort: {{ .Values.services.lgtm.loki }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lgtm
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: lgtm
  template:
    metadata:
      labels:
        app: lgtm
    spec:
      serviceAccountName: grafana-sidecar
      automountServiceAccountToken: true
      containers:
        - name: grafana-sc-dashboard
          image: "quay.io/kiwigrid/k8s-sidecar:1.27.4"
          imagePullPolicy: IfNotPresent
          env:
            - name: METHOD
              value: WATCH
            - name: LABEL
              value: "grafana_dashboard"
            - name: FOLDER
              value: "/tmp/dashboards" ##
            - name: RESOURCE
              value: "both"
            - name: FOLDER_ANNOTATION
              value: "grafana_folder"
            - name: REQ_USERNAME
              value: admin
            - name: REQ_PASSWORD
              value: admin
            - name: REQ_URL
              value: http://localhost:3000/api/admin/provisioning/dashboards/reload
            - name: REQ_METHOD
              value: POST
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            seccompProfile:
              type: RuntimeDefault
          volumeMounts: ##
            - name: sc-dashboard-volume
              mountPath: "/tmp/dashboards"
        - name: lgtm
          image: ghcr.io/silogen/docker-otel-lgtm:v1.0.7
          ports:
            - containerPort: 3000
            - containerPort: 4317
            - containerPort: 4318
            - containerPort: 9090
            - containerPort: 3100
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  curl -f http://localhost:9090/-/ready &&
                  curl -f http://localhost:3100/ready &&
                  curl -f http://localhost:3000/api/health
            initialDelaySeconds: 60
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 2
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  curl -f http://localhost:9090/-/ready &&
                  curl -f http://localhost:3100/ready &&
                  curl -f http://localhost:3000/api/health
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 15
            failureThreshold: 3
          resources:
            requests:
              cpu: "500m"
              memory: "1024Mi"
            limits:
              memory: "8Gi"
          # NOTE: By default OpenShift does not allow writing the root directory.
          # Thats why the data dirs for grafana, prometheus and loki can not be
          # created and the pod never becomes ready.
          # See: https://github.com/grafana/docker-otel-lgtm/issues/132
          volumeMounts:
            - name: tempo-data
              mountPath: /data/tempo
            - name: grafana-data
              mountPath: /data/grafana
            - name: loki-data
              mountPath: /data/loki
            - name: loki-storage
              mountPath: /loki
            - name: p8s-storage
              mountPath: /data/prometheus
            - name: sc-dashboard-volume ##
              mountPath: "/tmp/dashboards"
            - name: sc-dashboard-provider ##
              mountPath: "/otel-lgtm/grafana/conf/provisioning/dashboards/sc-dashboardproviders.yaml"
              subPath: provider.yaml
      volumes:
        - name: tempo-data
          persistentVolumeClaim:
            claimName: tempo-pvc
        - name: loki-data
          persistentVolumeClaim:
            claimName: loki-data-pvc
        - name: grafana-data
          persistentVolumeClaim:
            claimName: grafana-pvc
        - name: loki-storage
          persistentVolumeClaim:
            claimName: loki-storage-pvc
        - name: p8s-storage
          persistentVolumeClaim:
            claimName: p8s-pvc
        - name: sc-dashboard-volume ##
          emptyDir:
            {}
        - name: sc-dashboard-provider ##
          configMap:
            name: grafana-config-dashboards
