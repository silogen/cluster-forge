# Copyright Â© Advanced Micro Devices, Inc., or its affiliates.
#
# SPDX-License-Identifier: MIT

---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-cnpg-password-sync"
  namespace: "{{ .Release.Namespace }}"
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: password-sync
        image: postgres:17-alpine
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for CNPG cluster to be ready..."
          
          # Wait for PostgreSQL to accept connections
          until pg_isready -h {{ .Release.Name }}-cnpg-rw.{{ .Release.Namespace }}.svc.cluster.local -p 5432 -U airm_user; do
            echo "Waiting for PostgreSQL..."
            sleep 3
          done
          
          echo "PostgreSQL is ready. Syncing password..."
          
          # Use superuser to set the password
          PGPASSWORD="$SUPERUSER_PASSWORD" psql \
            -h {{ .Release.Name }}-cnpg-rw.{{ .Release.Namespace }}.svc.cluster.local \
            -p 5432 \
            -U postgres \
            -d postgres \
            -c "ALTER USER airm_user WITH PASSWORD '$DB_PASSWORD';"
          
          echo "Password synced. Verifying connection..."
          
          # Verify the password works
          if PGPASSWORD="$DB_PASSWORD" psql \
            -h {{ .Release.Name }}-cnpg-rw.{{ .Release.Namespace }}.svc.cluster.local \
            -p 5432 \
            -U airm_user \
            -d airm \
            -c "SELECT 1;" > /dev/null 2>&1; then
            echo "SUCCESS: Password verified!"
          else
            echo "ERROR: Password verification failed!"
            exit 1
          fi
        env:
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: "{{ .Release.Name }}-cnpg-user"
              key: password
        - name: SUPERUSER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: "{{ .Release.Name }}-cnpg-superuser"
              key: password
