---
apiVersion: batch/v1
kind: Job
metadata:
  name: '{{ .Release.Name }}-secret-generator'
  annotations:
    helm.sh/hook: pre-install
  namespace: '{{ .Release.Namespace }}'
spec:
  template:
    spec:
      serviceAccountName: '{{ .Release.Name }}-secret-generator-sa'
      containers:
      - name: secret-generator
        image: '{{ .Values.secretgenerator.image.repository }}:{{ .Values.secretgenerator.image.tag }}'
        imagePullPolicy: '{{ .Values.secretgenerator.image.pullPolicy }}'
        command: ["/bin/bash"]
        args: ["/scripts/generate-secrets.sh"]
        volumeMounts:
        - name: script-volume
          mountPath: /scripts
      volumes:
      - name: script-volume
        configMap:
          name: '{{ .Release.Name }}-secret-generator-script'
          defaultMode: 0755
      restartPolicy: OnFailure
  backoffLimit: 3
