---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: '{{ .Release.Name }}-airm-cnpg'
  namespace: '{{ .Release.Namespace }}'
spec:
  affinity:
    enablePodAntiAffinity: true
    topologyKey: topology.kubernetes.io/zone
  bootstrap:
    initdb:
      database: airm
      owner: airm_user
      postInitSQL:
        - GRANT CREATE ON SCHEMA public TO airm_user
      secret:
        name: '{{ .Release.Name }}-airm-cnpg-user'
  imageName: {{ .Values.airm.postgresql.cnpg.image }}
  instances: {{ .Values.airm.postgresql.cnpg.instance }}
  nodeMaintenanceWindow:
    inProgress: false
    reusePVC: true
  postgresql:
    parameters:
      auto_explain.log_min_duration: "10s"
      pg_stat_statements.max: "10000"
      pg_stat_statements.track: "all"
      shared_buffers: "256MB"
      wal_compression: "pglz" # default is "off"
    pg_hba:
      - host all all 10.244.0.0/16 md5
  primaryUpdateStrategy: unsupervised
  resources:
    {{- toYaml .Values.airm.postgresql.cnpg.resources | nindent 4 }}
  startDelay: 300
  stopDelay: 300
  storage:
    {{- toYaml .Values.airm.postgresql.cnpg.storage | nindent 4 }}
  superuserSecret:
    name: '{{ .Release.Name }}-airm-cnpg-superuser' # airm-cnpg-superuser
  walStorage:
    {{- toYaml .Values.airm.postgresql.cnpg.walStorage | nindent 4 }}