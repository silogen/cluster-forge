apiVersion: v1
kind: ConfigMap
metadata:
  name: gitea-config-script
  namespace: cf-gitea
data:
  configure-gitea.sh: |
    #!/bin/bash
    
    echo "Waiting for keycloak to be ready..."
    kubectl rollout status deploy/keycloak -n keycloak
    
    echo "Enabling openidConnect for " 
    kubectl -n cf-gitea exec deploy/gitea -c gitea -- \
      gitea admin auth add-oauth \
      --name "Keycloak" \
      --provider openidConnect \
      --key "gitea" \
      --secret ${CLIENT_SECRET} \
      --group-claim-name "groups" \
      --scopes "groups" \
      --group-team-map "{\"/gitea-users\":{\"cluster-org\":[\"Owners\"]}}" \
      --auto-discover-url "https://kc.${DOMAIN}/realms/airm/.well-known/openid-configuration"
    
    echo "Restarting gitea..."
    kubectl rollout restart deploy/gitea -n cf-gitea
    
    echo "Waiting for gitea to be ready..."
    kubectl rollout status deploy/gitea -n cf-gitea
