name: Release Pipeline

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (leave empty to auto-calculate)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.semver.outputs.next }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Calculate Next Version
        id: calculate_version
        uses: ietf-tools/semver-action@v1
        with:
          branch: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          maxTagsToFetch: 100
          skipInvalidTags: true
          patchAll: true

      - name: Set Next Version
        id: semver
        run: |
          VERSION="${{ github.event.inputs.version_override }}"
          if [[ -z "$VERSION" ]]; then
            echo "Using auto-calculated version: $VERSION"
            VERSION="${{ steps.calculate_version.outputs.next }}"
          else
            echo "Using manual override version: $VERSION"
          fi
          echo "next=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate LATEST_RELEASE matches release version
        env:
          VERSION: ${{ steps.semver.outputs.next }}
        run: |
          # Extract LATEST_RELEASE from bootstrap.sh
          LATEST_RELEASE=$(grep '^LATEST_RELEASE=' scripts/bootstrap.sh | cut -d'"' -f2 | sed 's/^v//')
          
          # Extract base version (before -rc or -alpha, etc.)
          RELEASE_BASE=$(echo "$VERSION" | sed 's/^v//' | sed 's/-rc[0-9]*$//' | sed 's/-alpha[0-9]*$//' | sed 's/-beta[0-9]*$//')
          LATEST_BASE=$(echo "$LATEST_RELEASE" | sed 's/-rc[0-9]*$//' | sed 's/-alpha[0-9]*$//' | sed 's/-beta[0-9]*$//')
          
          echo "Release version: $VERSION (base: $RELEASE_BASE)"
          echo "LATEST_RELEASE in bootstrap.sh: $LATEST_RELEASE (base: $LATEST_BASE)"
          
          if [[ "$RELEASE_BASE" != "$LATEST_BASE" ]]; then
            echo "::warning::LATEST_RELEASE base version ($LATEST_BASE) in scripts/bootstrap.sh does not match release version base ($RELEASE_BASE)"
            echo "::warning::Consider updating LATEST_RELEASE in scripts/bootstrap.sh to match the release being created"
          else
            echo "✓ LATEST_RELEASE base version matches release version base"
          fi

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.semver.outputs.next }}
        run: |
          # Prepare release artifact
          tar -zcvf "release-enterprise-ai-${VERSION}.tar.gz" --transform 's,^,cluster-forge/,' root/ scripts/ sources
          
          # Create release
          gh release create "$VERSION" "release-enterprise-ai-${VERSION}.tar.gz#ClusterForge Enterprise AI Package" \
            --title="ClusterForge Release $VERSION" \
            --generate-notes \
            --prerelease || true # Ignore if release already exists

  sbom:
    needs: [release]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.release.outputs.new_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate SBOM
        id: generate_sbom
        working-directory: ./sbom
        run: |
          echo "Generating SBOM for release ${VERSION}..."
          
          chmod +x generate-sbom.sh
          ./generate-sbom.sh
          
          if [[ ! -f "SBOM.md" ]]; then
            echo "❌ Error: SBOM.md was not generated"
            exit 1
          fi
          
          # Create the renamed SBOM file with release name and git hash
          SHORT_HASH=$(echo "${{ github.sha }}" | cut -c1-7)
          NEW_SBOM_NAME="sbom-${VERSION}-${SHORT_HASH}.md"
          
          cp SBOM.md "$NEW_SBOM_NAME"
          echo "✅ SBOM generated successfully as $NEW_SBOM_NAME"
          
          # Show SBOM summary
          echo ""
          echo "=== SBOM Summary ==="
          echo "Release: ${VERSION}"
          echo "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Count components in each category
          all_components=$(yq eval '.components | keys | length' components.yaml)
          helm_components=$(yq eval '.components | to_entries | map(select(.value.valuesFile != null)) | length' components.yaml)
          manifest_components=$((all_components - helm_components))
          
          echo "Total components: $all_components"
          echo "Helm charts: $helm_components"
          echo "Kubernetes manifests: $manifest_components"
          echo "===================="
          
          echo "sbom_name=${NEW_SBOM_NAME}" >> $GITHUB_OUTPUT

      - name: Upload SBOM as artifact
        working-directory: ./sbom
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SBOM_NAME: ${{ steps.generate_sbom.outputs.sbom_name }}
        run: |
          gh release upload ${VERSION} ${SBOM_NAME} --clobber
