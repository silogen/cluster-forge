apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-oauth-config
  namespace: keycloak
spec:
  template:
    spec:
      containers:
      - name: gitea-config
        image: gitea/gitea:latest
        command: ["/bin/sh"]
        args:
          - -c
          - |
            gitea admin auth add-oauth \
              --name "Keycloak" \
              --provider openidConnect \
              --key "gitea" \
              --secret ${CLIENT_SECRET} \
              --group-claim-name "groups" \
              --scopes "groups" \
              --group-team-map "{\"/gitea-users\":{\"forgetest\":[\"Developers\"]}}" \
              --auto-discover-url "https://kc.not-a-domain/realms/k8s/.well-known/openid-configuration"
        env:
        - name: CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: k8s-realm-credentials
              key: GITEA_CLIENT_SECRET
        volumeMounts:
        - name: gitea-data
          mountPath: /data
      volumes:
      - name: gitea-data
        persistentVolumeClaim:
          claimName: gitea-data
      restartPolicy: OnFailure
  backoffLimit: 3