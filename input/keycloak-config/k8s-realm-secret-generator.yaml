apiVersion: v1
kind: ConfigMap
metadata:
  name: k8srealm-secret-generator-script
  namespace: default
data:
  generate-secrets.sh: |
    #!/bin/bash
    set -e
    
    # Generate alphanumeric secret function
    generate_secret() {
        openssl rand -hex 16 | tr 'a-f' 'A-F' | head -c 32
    }
    
    # Generate all secrets first
    GITEA_CLIENT_SECRET=$(generate_secret)
    GITEA_ADMIN_PASSWORD=$(generate_secret)

    # Create the ClusterSecretStore YAML with pre-generated secrets
    cat > /tmp/final-secret-store.yaml << EOF
    apiVersion: external-secrets.io/v1beta1
    kind: ClusterSecretStore
    metadata:
      name: k8srealm-secret-store
    spec:
      provider:
        fake:
          data:
          - key: gitea-client-secret
            value: ${GITEA_CLIENT_SECRET}
          - key: gitea-admin-password
            value: ${GITEA_ADMIN_PASSWORD}
          - key: gitea-admin-username
            value: silogen-admin
    EOF
    
    # Apply the secret store
    kubectl apply -f /tmp/final-secret-store.yaml
    
    echo "ClusterSecretStore created successfully!"
    echo "Generated secrets with alphanumeric values only"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: k8srealm-secret-generator
  namespace: default
spec:
  template:
    spec:
      serviceAccountName: k8srealm-secret-generator-sa
      containers:
      - name: k8srealm-secret-generator
        image: bitnami/kubectl:latest
        command: ["/bin/bash"]
        args: ["/scripts/generate-secrets.sh"]
        volumeMounts:
        - name: script-volume
          mountPath: /scripts
      volumes:
      - name: script-volume
        configMap:
          name: k8srealm-secret-generator-script
          defaultMode: 0755
      restartPolicy: OnFailure
  backoffLimit: 3

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8srealm-secret-generator-sa
  namespace: default

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: k8srealm-secret-generator-role
rules:
- apiGroups: ["external-secrets.io"]
  resources: ["clustersecretstores"]
  verbs: ["create", "update", "patch", "get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: k8srealm-secret-generator-binding
subjects:
- kind: ServiceAccount
  name: k8srealm-secret-generator-sa
  namespace: default
roleRef:
  kind: ClusterRole
  name: k8srealm-secret-generator-role
  apiGroup: rbac.authorization.k8s.io