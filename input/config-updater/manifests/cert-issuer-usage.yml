apiVersion: batch/v1
kind: Job
metadata:
  name: gateway-cert-usage
  namespace: default
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: cert-manager-usage
        image: alpine:latest
        env:
        - name: FILE_PATH
          value: "kyverno/ClusterPolicy_mutate-certificate-issuerref.yaml"
        - name: COMMIT_MESSAGE
          value: "updated cert manager reference"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        command: ["/bin/sh"]
        args:
        - -c
        - |
          set -e
          [[ "${USE_CERT_MANAGER:-}" == "false" ]] && exit 0
          apk add --no-cache git yq
          git config --global user.name "K8s Gateway Updater"
          git config --global user.email "gateway-updater@cluster.local"
          
          cd /workspace
          echo "Cloning repository: clusterforge"
          git clone http://forge:clusterforge@gitea-http.cf-gitea.svc.cluster.local:3000/forge/clusterforge.git repo
          cd repo
          if [ ! -f "$FILE_PATH" ]; then
            echo "Error: File $FILE_PATH not found"
            exit 1
          fi
          echo "Current content of $FILE_PATH:"
          cat "$FILE_PATH"

          NEW_NAME="cluster-issuer"
          NEW_KIND="ClusterIssuer"

          yq eval -i ".spec.rules[0].mutate.patchStrategicMerge.spec.issuerRef.name = \"$NEW_NAME\" | .spec.rules[0].mutate.patchStrategicMerge.spec.issuerRef.kind = \"$NEW_KIND\"" $FILE_PATH
          
          echo "Updated content:"
          cat "$FILE_PATH"

          if git diff --quiet; then
            echo "No changes detected."
            exit 0
          fi

          git add "$FILE_PATH"
          git commit -m "$COMMIT_MESSAGE: Updated cert-manager issuer policy"

          git remote set-url origin http://forge:clusterforge@gitea-http.cf-gitea.svc.cluster.local:3000/forge/clusterforge.git
          git push origin master
          
          echo "Successfully updated $FILE_PATH with updated cert-manager issuer policy and pushed to master"
      volumes:
      - name: workspace
        emptyDir: {}