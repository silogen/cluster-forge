apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-secret-generator-script
  namespace: minio-tenant-default
data:
  generate-secrets.sh: |
    #!/bin/bash
    set -e
    
    # Generate alphanumeric secret function
    generate_secret() {
        openssl rand -hex 16 | tr 'a-f' 'A-F' | head -c 32
    }
    
    # Generate all secrets first
    MINIO_KEYCLOAK_CLIENT_SECRET=$(generate_secret)
    MINIO_ROOT_PASSWORD=$(generate_secret)

    # Create the ClusterSecretStore YAML with pre-generated secrets
    cat > /tmp/final-secret-store.yaml << EOF
    apiVersion: external-secrets.io/v1beta1
    kind: ClusterSecretStore
    metadata:
      name: minio-secret-store
    spec:
      provider:
        fake:
          data:
          - key: minio-keycloak-client-secret
            value: ${MINIO_KEYCLOAK_CLIENT_SECRET}
          - key: minio-keycloak-client-config
            value: |
              export MINIO_SERVER_URL="http://minio:80"
              export MINIO_API_ROOT_ACCESS="on"
              export MINIO_ROOT_USER="minioroot"
              export MINIO_ROOT_PASSWORD="${MINIO_ROOT_PASSWORD}"
              export MINIO_IDENTITY_OPENID_CLIENT_SECRET="${MINIO_KEYCLOAK_CLIENT_SECRET}"

    EOF
    
    # Apply the secret store
    kubectl apply -f /tmp/final-secret-store.yaml
    
    echo "ClusterSecretStore created successfully!"
    echo "Generated secrets with alphanumeric values only"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-secret-generator
  namespace: minio-tenant-default
spec:
  template:
    spec:
      serviceAccountName: minio-secrets-readonly
      containers:
      - name: minio-secret-generator
        image: bitnami/kubectl:latest
        command: ["/bin/bash"]
        args: ["/scripts/generate-secrets.sh"]
        volumeMounts:
        - name: script-volume
          mountPath: /scripts
      volumes:
      - name: script-volume
        configMap:
          name: minio-secret-generator-script
          defaultMode: 0755
      restartPolicy: OnFailure
  backoffLimit: 3
