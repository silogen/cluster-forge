apiVersion: v1
kind: ConfigMap
metadata:
  name: gitea-init-local-script
  namespace: cf-gitea
data:
  init-gitea.sh: |
    #!/bin/sh
    set -e
    
    GITEA_URL="http://gitea-http.cf-gitea.svc:3000"
    GITEA_ADMIN_USER=$(cat /secrets/username)
    GITEA_ADMIN_PASSWORD=$(cat /secrets/password)
    
    echo "Waiting for Gitea to be ready..."
    MAX_WAIT=120
    ELAPSED=0
    until curl -s "${GITEA_URL}/api/v1/version" >/dev/null 2>&1; do
      sleep 2
      ELAPSED=$((ELAPSED + 2))
      if [ $ELAPSED -ge $MAX_WAIT ]; then
        echo "ERROR: Gitea did not become ready in time"
        exit 1
      fi
      echo "Still waiting... (${ELAPSED}s)"
    done
    
    echo "Gitea is ready!"
    
    echo "Step 1: Generating access token..."
    GITEA_TOKEN=$(curl -s -X POST "${GITEA_URL}/api/v1/users/${GITEA_ADMIN_USER}/tokens" \
      -u "${GITEA_ADMIN_USER}:${GITEA_ADMIN_PASSWORD}" \
      -H "Content-Type: application/json" \
      -d '{"name": "init-token", "scopes": ["write:admin", "write:organization", "write:repository", "write:user"]}' | \
      grep -o '"sha1":"[^"]*"' | cut -d'"' -f4)
    
    if [ -z "$GITEA_TOKEN" ]; then
      echo "ERROR: Failed to generate access token"
      exit 1
    fi
    
    echo "Token generated successfully"
    
    echo "Step 2: Creating organization 'cluster-org'..."
    curl -X POST "${GITEA_URL}/api/v1/orgs" \
      -H "Authorization: token ${GITEA_TOKEN}" \
      -H "Content-Type: application/json" \
      -d '{
        "username": "cluster-org",
        "full_name": "Cluster Organization",
        "description": "Organization for cluster repositories"
      }' || echo "Organization might already exist"
    
    echo "Step 3: Creating repository 'cluster-forge' (local, not mirror)..."
    if curl -s -f -H "Authorization: token ${GITEA_TOKEN}" "${GITEA_URL}/api/v1/repos/cluster-org/cluster-forge" >/dev/null 2>&1; then
      echo "Repository 'cluster-forge' already exists, deleting it first..."
      curl -X DELETE "${GITEA_URL}/api/v1/repos/cluster-org/cluster-forge" \
        -H "Authorization: token ${GITEA_TOKEN}"
      sleep 2
    fi
    
    echo "Creating empty repository..."
    curl -X POST "${GITEA_URL}/api/v1/orgs/cluster-org/repos" \
      -H "Authorization: token ${GITEA_TOKEN}" \
      -H "Content-Type: application/json" \
      -d '{
        "name": "cluster-forge",
        "description": "Cluster Forge - Local Development",
        "private": false,
        "auto_init": false,
        "default_branch": "main"
      }'
    
    if [ $? -ne 0 ]; then
      echo "ERROR: Failed to create repository"
      exit 1
    fi
    
    echo "‚úÖ Repository created successfully"
    
    echo "Step 4: Creating repository 'cluster-values'..."
    curl -X POST "${GITEA_URL}/api/v1/orgs/cluster-org/repos" \
      -H "Authorization: token ${GITEA_TOKEN}" \
      -H "Content-Type: application/json" \
      -d '{
        "name": "cluster-values",
        "description": "Cluster configuration values repository",
        "private": false,
        "auto_init": true
      }' || echo "Repository might already exist"
    
    echo "Step 5: Creating user 'devuser'..."
    curl -X POST "${GITEA_URL}/api/v1/admin/users" \
      -H "Authorization: token ${GITEA_TOKEN}" \
      -H "Content-Type: application/json" \
      -d '{
        "username": "devuser",
        "email": "devuser@'${DOMAIN}'",
        "password": "password",
        "full_name": "Dev User",
        "must_change_password": false,
        "send_notify": false
      }' || echo "User creation failed, might already exist"
    
    echo "Step 6: Getting organization 'cluster-org' owners team id..."
    OWNERS_TEAM_ID=$(curl -s -H "Authorization: token ${GITEA_TOKEN}" \
      "${GITEA_URL}/api/v1/orgs/cluster-org/teams" | \
      grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
    
    if [ -n "$OWNERS_TEAM_ID" ]; then
      echo "Adding devuser to owners team (ID: ${OWNERS_TEAM_ID})..."
      curl -X PUT "${GITEA_URL}/api/v1/teams/${OWNERS_TEAM_ID}/members/devuser" \
        -H "Authorization: token ${GITEA_TOKEN}"
    fi
    
    echo "Step 7: Uploading initial cluster values..."
    curl -X POST "${GITEA_URL}/api/v1/repos/cluster-org/cluster-values/contents/values_local_kind.yaml" \
      -H "Authorization: token ${GITEA_TOKEN}" \
      -H "Content-Type: application/json" \
      -d "{
        \"content\": \"$(base64 -w0 /config/initial-cf-values 2>/dev/null || base64 /config/initial-cf-values)\",
        \"message\": \"Initial cluster values for local kind\"
      }" || echo "File might already exist"
    
    echo "‚úÖ Gitea initialization complete!"
    echo "üìù Note: Push your local repository with:"
    echo "   git push http://${GITEA_ADMIN_USER}:<password>@gitea.${DOMAIN}:3000/cluster-org/cluster-forge.git HEAD:main --force"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-init-local-job
  namespace: cf-gitea
spec:
  ttlSecondsAfterFinished: 86400
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-gitea
        image: curlimages/curl:8.16.0
        command: ["/bin/sh", "/scripts/init-gitea.sh"]
        env:
        - name: DOMAIN
          value: {{ .Values.domain | quote }}
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: secrets
          mountPath: /secrets
        - name: config
          mountPath: /config
      volumes:
      - name: scripts
        configMap:
          name: gitea-init-local-script
          defaultMode: 0755
      - name: secrets
        secret:
          secretName: gitea-admin-credentials
      - name: config
        configMap:
          name: initial-cf-values
