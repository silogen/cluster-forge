apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-init-scripts
  namespace: cf-openbao
data:
  init-openbao.sh: |
    #!/bin/bash
    
    set -e
    
    echo "Checking OpenBao status on openbao-0..."
    OPENBAO_0_STATUS=$(kubectl exec openbao-0 -n cf-openbao -- bao status 2>&1 || true)
    OPENBAO_0_INITIALIZED=$(echo "$OPENBAO_0_STATUS" | grep -q "Initialized.*true" && echo "true" || echo "false")
    OPENBAO_0_SEALED=$(echo "$OPENBAO_0_STATUS" | grep -q "Sealed.*true" && echo "true" || echo "false")
    
    if [ "$OPENBAO_0_INITIALIZED" = "true" ] && [ "$OPENBAO_0_SEALED" = "false" ]; then
      echo "OpenBao openbao-0 is already initialized and unsealed."
      
      # Dynamically detect HA replicas by checking for openbao-1, openbao-2, etc.
      echo "Checking for HA replica pods..."
      if kubectl get secret openbao-keys -n cf-openbao &>/dev/null; then
        BAO_UNSEAL_KEY=$(kubectl get secret openbao-keys -n cf-openbao -o jsonpath='{.data.unseal_key}' | base64 -d)
        
        # Check for replica pods (openbao-1, openbao-2, etc.)
        REPLICA_PODS=$(kubectl get pods -n cf-openbao -l app.kubernetes.io/name=openbao -o name | grep -v "openbao-0" | sed 's/pod\///' || true)
        
        if [ -n "$REPLICA_PODS" ]; then
          echo "Found HA replicas: $REPLICA_PODS"
          
          for replica in $REPLICA_PODS; do
            echo "Checking $replica status..."
            REPLICA_STATUS=$(kubectl exec $replica -n cf-openbao -- bao status 2>&1 || true)
            REPLICA_SEALED=$(echo "$REPLICA_STATUS" | grep -q "Sealed.*true" && echo "true" || echo "false")
            REPLICA_INITIALIZED=$(echo "$REPLICA_STATUS" | grep -q "Initialized.*true" && echo "true" || echo "false")
            
            if [ "$REPLICA_SEALED" = "true" ] || [ "$REPLICA_INITIALIZED" = "false" ]; then
              echo "Setting up $replica..."
              if [ "$REPLICA_INITIALIZED" = "false" ]; then
                echo "Joining $replica to Raft cluster..."
                kubectl exec $replica -n cf-openbao -- bao operator raft join http://openbao-0.openbao-internal:8200 || echo "Already joined or join failed"
              fi
              if [ "$REPLICA_SEALED" = "true" ]; then
                echo "Unsealing $replica..."
                kubectl exec $replica -n cf-openbao -- sh -c "bao operator unseal \"$BAO_UNSEAL_KEY\""
              fi
              kubectl wait --for=condition=ready pod/$replica --timeout=300s -n cf-openbao || echo "Warning: $replica not ready"
            else
              echo "$replica is already unsealed and ready."
            fi
          done
          
          echo "HA cluster setup verified/completed!"
        else
          echo "No HA replicas found (single-node deployment)."
        fi
      else
        echo "ERROR: openbao-keys secret not found. Cannot unseal replicas."
        exit 1
      fi
      
      echo "OpenBao is fully operational. Skipping initialization."
      exit 0
    fi
    
    if [ "$OPENBAO_0_INITIALIZED" = "false" ]; then
      echo "Initializing OpenBao on openbao-0..."
      INIT_OUTPUT=$(kubectl exec openbao-0 -- bao operator init -format=json -key-shares=1 -key-threshold=1)
      echo $INIT_OUTPUT > /tmp/bao-keys.json;

      echo "Saving unseal keys and root token to openbao-keys k8s secret..."        
      BAO_ROOT_TOKEN=$(jq -r '.root_token' /tmp/bao-keys.json);
      BAO_UNSEAL_KEY=$(jq -r '.unseal_keys_b64[0]' /tmp/bao-keys.json);    
      kubectl create secret generic openbao-keys -n cf-openbao \
        --from-literal=root_token="$BAO_ROOT_TOKEN" \
        --from-literal=unseal_key="$BAO_UNSEAL_KEY" \
        --dry-run=client -o yaml | kubectl apply -f -
    else
      echo "OpenBao openbao-0 is initialized but sealed. Getting unseal key..."
      BAO_UNSEAL_KEY=$(kubectl get secret openbao-keys -n cf-openbao -o jsonpath='{.data.unseal_key}' | base64 -d)
    fi
    
    echo "Unsealing openbao-0..."
    kubectl exec openbao-0 -n cf-openbao -- sh -c "bao operator unseal \"$BAO_UNSEAL_KEY\""
    kubectl wait --for=condition=ready pod/openbao-0 --timeout=300s -n cf-openbao
    
    # Dynamically detect and setup HA replicas
    REPLICA_PODS=$(kubectl get pods -n cf-openbao -l app.kubernetes.io/name=openbao -o name | grep -v "openbao-0" | sed 's/pod\///' || true)
    
    if [ -n "$REPLICA_PODS" ]; then
      echo "HA mode detected. Setting up Raft cluster with replicas: $REPLICA_PODS"
      
      for replica in $REPLICA_PODS; do
        echo "Setting up $replica..."
        kubectl exec $replica -n cf-openbao -- bao operator raft join http://openbao-0.openbao-internal:8200
        kubectl exec $replica -n cf-openbao -- sh -c "bao operator unseal \"$BAO_UNSEAL_KEY\""
        kubectl wait --for=condition=ready pod/$replica --timeout=300s -n cf-openbao
      done
      
      echo "OpenBao Raft cluster initialization completed successfully!"
    else
      echo "OpenBao single-node initialization completed successfully!"
    fi

    
  setup-openbao.sh: |
    #!/bin/bash
    
    set -e
    
    generate_password() {
        openssl rand -hex 16 | tr 'a-f' 'A-F' | head -c 32
    }
    
    export BAO_TOKEN=$(kubectl get secret openbao-keys -n cf-openbao -o jsonpath='{.data.root_token}' | base64 -d)
     if [ -z "$BAO_TOKEN" ]; then
      echo "ERROR: Failed to retrieve root token from openbao-keys k8s secret"
      exit 1
    fi
        
    READONLY_PASSWORD=$(generate_password)
    
    kubectl create secret generic openbao-user \
      --from-literal=username=readonly-user \
      --from-literal=password=$READONLY_PASSWORD \
      --dry-run=client -o yaml | kubectl apply -f -
    
    echo "Enabling secrets KV engine..."
    if bao secrets list 2>/dev/null | grep -q "^secrets/"; then
      echo "Secrets engine already exists"
    else
     bao secrets enable -version=2 -path=secrets kv
    fi    

    echo "Enabling apikey-groups KV engine..."
    if bao secrets list 2>/dev/null | grep -q "^apikey-groups/"; then
      echo "apikey-groups engine already exists"
    else
     bao secrets enable -version=2 -path=apikey-groups kv
    fi

    echo "Configuring userpass auth..."
    if bao auth list 2>/dev/null | grep -q "^userpass/"; then
      echo "userpass auth already exists"
    else
      bao auth enable userpass
    fi
    
    echo "Creating read-policy..."
    echo '
    path "secrets/data/*" {
      capabilities = ["read"]
    }
    path "secrets/metadata/*" {
      capabilities = ["list"]
    }
    path "auth/token/lookup-self" {
      capabilities = ["read"]
    }
    path "auth/token/renew-self" {
      capabilities = ["update"]
    }' | bao policy write read-policy -
    
    echo "Creating reader-role..."
    bao write auth/userpass/users/readonly-user \
      policies=read-policy \
      password=$READONLY_PASSWORD
    
    echo "OpenBao configuration completed successfully!"


