apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-secret-manager-scripts
  namespace: cf-openbao
data:
  manage-secrets.sh: |
    #!/bin/bash
    
    set -e
    
    # Secret management script for OpenBao
    echo "OpenBao Secret Manager starting..."
    echo "DOMAIN: ${DOMAIN:-not-set}"
    echo "BAO_ADDR: ${BAO_ADDR:-not-set}"
    echo "BAO_TOKEN: ${BAO_TOKEN:0:10}..." # Only show first 10 chars for security
    
    # Ensure OpenBao is ready
    bao status
    
    # Function to generate random password
    generate_password() {
        openssl rand -hex 16 | tr 'a-f' 'A-F' | head -c 32
    }
    
    # Function to process secrets from configuration
    process_secrets_config() {
        echo "Processing secrets configuration..."
        
        if [ -f "/tmp/secrets/secrets.env" ]; then
            echo "Found secrets configuration file"
            
            # Process each line in the secrets configuration
            while IFS= read -r line; do
                # Skip empty lines and comments
                [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
                
                # Parse SECRET_PATH|TYPE|VALUE|BYTES format
                IFS='|' read -r secret_path secret_type secret_value bytes_length <<< "$line"
                
                # Skip if any required field is empty
                [[ -z "$secret_path" || -z "$secret_type" ]] && continue
                
                echo "Processing secret: $secret_path (type: $secret_type)"
                
                case "$secret_type" in
                    "static")
                        # Replace {{ .Values.domain }} template with actual domain
                        final_value="${secret_value//\{\{ \.Values\.domain \}\}/${DOMAIN}}"
                        bao kv put "$secret_path" value="$final_value"
                        ;;
                    "random")
                        # Generate random value with specified bytes
                        if [ -z "$bytes_length" ] || [ "$bytes_length" = "0" ]; then
                            bytes_length=32  # Default to 32 bytes
                        fi
                        random_value=$(openssl rand -hex "$bytes_length")
                        bao kv put "$secret_path" value="$random_value"
                        ;;
                    *)
                        echo "Warning: Unknown secret type '$secret_type' for $secret_path"
                        ;;
                esac
                
            done < "/tmp/secrets/secrets.env"
            
            echo "Secrets configuration processing completed"
        else
            echo "No secrets configuration file found at /tmp/secrets/secrets.env"
        fi
    }
    
    # Set special cluster-auth admin token
    if [ -n "$BAO_TOKEN" ]; then
        echo "Setting cluster-auth OpenBao token..."
        bao kv put secrets/cluster-auth-openbao-token value="$BAO_TOKEN"
    fi
    
    # Process secrets from configuration file
    process_secrets_config
    
    echo "Secret management completed successfully!"