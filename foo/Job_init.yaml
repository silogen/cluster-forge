---
apiVersion: batch/v1
kind: Job
metadata:
  name: openbao-init
  namespace: openbao
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - args:
            - while true;
              do
                bao status;
                retVal=$?;
                if [ $retVal -ne 1 ]; then
                  break;
                fi;
                sleep 1;
              done;
              if bao status; then
                echo already initialized;
                exit 0;
              else
                bao status; echo $?;
                echo not initialized yet, initializing ;
              fi;
              bao operator init -format=json -key-shares=1 -key-threshold=1 > /tmp/bao-keys.json;
              echo bao operator unseal $(cat /tmp/bao-keys.json|grep -A1 unseal_keys_b64|tail -n 1|cut -d '"' -f 2);
              bao operator unseal $(cat /tmp/bao-keys.json|grep -A1 unseal_keys_b64|tail -n 1|cut -d '"' -f 2);
              echo bao login $(cat /tmp/bao-keys.json|grep root_token|cut -d '"' -f 4);
              bao login $(cat /tmp/bao-keys.json|grep root_token|cut -d '"' -f 4);
              bao secrets enable -version=2 kv;
              bao kv put kv/scripted scripted-bar=scripted-baz;
              echo 'path "*" {' > /tmp/policy.hcl;
              echo '  capabilities = ["sudo", "read", "list", "create", "update", "delete", "patch"]' >> /tmp/policy.hcl;
              echo '}' >> /tmp/policy.hcl;
              bao policy write star /tmp/policy.hcl;
              bao auth enable jwt;
              bao write auth/jwt/config
                oidc_discovery_url=https://kubernetes.default.svc.cluster.local
                oidc_discovery_ca_pem=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt;
              bao write auth/jwt/role/vault-jwt-role
                role_type="jwt"
                bound_audiences='clusterforge'
                user_claim="sub"
                bound_subject="system:serviceaccount:openbao:openbao-test"
                policies="star"
                ttl="1h";
              bao auth enable userpass;
              bao write auth/userpass/users/admin password="admin" policies="star";
          command:
            - /bin/sh
            - -c
          env:
            - name: BAO_ADDR
              value: http://openbao-internal:8200
            - name: BAO_API_ADDR
              value: http://openbao-internal:8200
            - name: BAO_CLUSTER_ADDR
              value: http://openbao-internal:8201
          image: quay.io/openbao/openbao:2.4.1
          imagePullPolicy: IfNotPresent
          name: openbao-unseal
          resources:
            limits:
              cpu: 1000m
              memory: 2Gi
            requests:
              cpu: 500m
              memory: 512Mi
          securityContext:
            allowPrivilegeEscalation: false
      serviceAccountName: openbao
